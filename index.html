<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>水宅倉庫掃碼系統（釘釘專用）</title>
  <meta name="robots" content="noindex, nofollow" />
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.3/dingtalk.open.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    h2 { color: #0c7c59; }
    select, button {
      margin: 10px;
      padding: 14px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
    }
    select { width: 80%; max-width: 360px; }
    button { background-color: #0c7c59; color: white; cursor: pointer; }
    .tag {
      display: inline-block;
      background: #eee;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 6px;
    }
    .hidden { display: none; }
    #qr-reader { margin: 10px auto; max-width: 400px; }
    #log { font-size: 16px; text-align: left; margin-top: 16px; }
  </style>
</head>
<body>

  <h2>📦 水宅倉庫掃碼系統</h2>

  <div>
    <label>選擇模式</label><br>
    <select id="mode-select">
      <option value="register">📤 出貨模式</option>
      <option value="revoke">🔁 回收模式</option>
    </select>
  </div>

  <div>
    <label>選擇分店</label><br>
    <select id="shop-select">
      <option value="">請選擇</option>
    </select>
  </div>

  <button id="scan-btn">📷 掃描 QR Code</button>

  <div id="qr-reader" class="hidden"></div>

  <div id="sn-display"></div>

  <button id="submit-btn" class="hidden">📤 送出資料</button>

  <div id="log"></div>

  <script>
    const webhookURL = "https://hook.us2.make.com/s6ibl5e715634fhq7ess7sc5bv0fuj6h";
    const shopDataURL = "https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec";

    let mode = "register";
    let shop = "";
    let scanned = [];
    let lastScan = 0;

    document.getElementById("mode-select").addEventListener("change", e => {
      mode = e.target.value;
      document.getElementById("log").innerHTML += `切換模式：${mode}<br>`;
    });

    fetch(shopDataURL)
      .then(r => r.json())
      .then(data => {
        const select = document.getElementById("shop-select");
        data.forEach(d => {
          if (d.分店) {
            const o = document.createElement("option");
            o.value = d.分店;
            o.textContent = d.分店;
            select.appendChild(o);
          }
        });
      });

    document.getElementById("shop-select").addEventListener("change", e => {
      shop = e.target.value;
      document.getElementById("log").innerHTML += `選擇分店：${shop}<br>`;
    });

    document.getElementById("scan-btn").addEventListener("click", () => {
      if (mode === "register" && !shop) {
        alert("請先選擇出貨店家");
        return;
      }

      if (!window.dd) {
        alert("請從釘釘應用圖示進入系統，否則無法啟用掃碼功能。");
        return;
      }

      dd.ready(() => {
        dd.biz.util.scan({
          type: "qr",
          onSuccess: res => {
            const url = res.text || "";
            const sn = new URLSearchParams(url.split("?")[1]).get("sn");
            if (sn && !scanned.includes(sn)) {
              scanned.push(sn);
              updateDisplay();
              document.getElementById("submit-btn").classList.remove("hidden");
              log(`✅ 掃描成功：${sn}`);
            } else {
              log("⚠️ 無效或重複瓶號");
            }
          },
          onFail: err => {
            log("❌ 掃描失敗：" + JSON.stringify(err));
          }
        });
      });
    });

    document.getElementById("submit-btn").addEventListener("click", () => {
      if (mode === "register" && !shop) {
        alert("請選擇出貨店家");
        return;
      }
      if (scanned.length === 0) {
        alert("請至少掃描一組瓶號");
        return;
      }

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode: mode,
          shop: shop,
          sn_list: scanned,
          operator: "倉管"
        })
      }).then(r => {
        if (r.ok) {
          log("✅ 資料送出成功");
          scanned = [];
          updateDisplay();
        } else {
          log("❌ 資料送出失敗");
        }
      });
    });

    function updateDisplay() {
      document.getElementById("sn-display").innerHTML =
        scanned.map(sn => `<span class="tag">${sn}</span>`).join("");
    }

    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      document.getElementById("log").innerHTML += `[${ts}] ${msg}<br>`;
    }

    if (!window.dd) {
      log("❌ JSAPI 尚未注入，請從釘釘應用圖示進入");
    } else {
      log("✅ 已偵測到 JSAPI 可使用");
    }
  </script>
</body>
</html>
