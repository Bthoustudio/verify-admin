<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ°´å®…å€‰åº«æƒç¢¼ç³»çµ±ï¼ˆé‡˜é‡˜å°ˆç”¨ï¼‰</title>
  <meta name="robots" content="noindex, nofollow" />
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.3/dingtalk.open.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    h2 { color: #0c7c59; }
    select, button {
      margin: 10px;
      padding: 14px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
    }
    select { width: 80%; max-width: 360px; }
    button { background-color: #0c7c59; color: white; cursor: pointer; }
    .tag {
      display: inline-block;
      background: #eee;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 6px;
    }
    .hidden { display: none; }
    #qr-reader { margin: 10px auto; max-width: 400px; }
    #log { font-size: 16px; text-align: left; margin-top: 16px; }
  </style>
</head>
<body>

  <h2>ğŸ“¦ æ°´å®…å€‰åº«æƒç¢¼ç³»çµ±</h2>

  <div>
    <label>é¸æ“‡æ¨¡å¼</label><br>
    <select id="mode-select">
      <option value="register">ğŸ“¤ å‡ºè²¨æ¨¡å¼</option>
      <option value="revoke">ğŸ” å›æ”¶æ¨¡å¼</option>
    </select>
  </div>

  <div>
    <label>é¸æ“‡åˆ†åº—</label><br>
    <select id="shop-select">
      <option value="">è«‹é¸æ“‡</option>
    </select>
  </div>

  <button id="scan-btn">ğŸ“· æƒæ QR Code</button>

  <div id="qr-reader" class="hidden"></div>

  <div id="sn-display"></div>

  <button id="submit-btn" class="hidden">ğŸ“¤ é€å‡ºè³‡æ–™</button>

  <div id="log"></div>

  <script>
    const webhookURL = "https://hook.us2.make.com/s6ibl5e715634fhq7ess7sc5bv0fuj6h";
    const shopDataURL = "https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec";

    let mode = "register";
    let shop = "";
    let scanned = [];
    let lastScan = 0;

    document.getElementById("mode-select").addEventListener("change", e => {
      mode = e.target.value;
      document.getElementById("log").innerHTML += `åˆ‡æ›æ¨¡å¼ï¼š${mode}<br>`;
    });

    fetch(shopDataURL)
      .then(r => r.json())
      .then(data => {
        const select = document.getElementById("shop-select");
        data.forEach(d => {
          if (d.åˆ†åº—) {
            const o = document.createElement("option");
            o.value = d.åˆ†åº—;
            o.textContent = d.åˆ†åº—;
            select.appendChild(o);
          }
        });
      });

    document.getElementById("shop-select").addEventListener("change", e => {
      shop = e.target.value;
      document.getElementById("log").innerHTML += `é¸æ“‡åˆ†åº—ï¼š${shop}<br>`;
    });

    document.getElementById("scan-btn").addEventListener("click", () => {
      if (mode === "register" && !shop) {
        alert("è«‹å…ˆé¸æ“‡å‡ºè²¨åº—å®¶");
        return;
      }

      if (!window.dd) {
        alert("è«‹å¾é‡˜é‡˜æ‡‰ç”¨åœ–ç¤ºé€²å…¥ç³»çµ±ï¼Œå¦å‰‡ç„¡æ³•å•Ÿç”¨æƒç¢¼åŠŸèƒ½ã€‚");
        return;
      }

      dd.ready(() => {
        dd.biz.util.scan({
          type: "qr",
          onSuccess: res => {
            const url = res.text || "";
            const sn = new URLSearchParams(url.split("?")[1]).get("sn");
            if (sn && !scanned.includes(sn)) {
              scanned.push(sn);
              updateDisplay();
              document.getElementById("submit-btn").classList.remove("hidden");
              log(`âœ… æƒææˆåŠŸï¼š${sn}`);
            } else {
              log("âš ï¸ ç„¡æ•ˆæˆ–é‡è¤‡ç“¶è™Ÿ");
            }
          },
          onFail: err => {
            log("âŒ æƒæå¤±æ•—ï¼š" + JSON.stringify(err));
          }
        });
      });
    });

    document.getElementById("submit-btn").addEventListener("click", () => {
      if (mode === "register" && !shop) {
        alert("è«‹é¸æ“‡å‡ºè²¨åº—å®¶");
        return;
      }
      if (scanned.length === 0) {
        alert("è«‹è‡³å°‘æƒæä¸€çµ„ç“¶è™Ÿ");
        return;
      }

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode: mode,
          shop: shop,
          sn_list: scanned,
          operator: "å€‰ç®¡"
        })
      }).then(r => {
        if (r.ok) {
          log("âœ… è³‡æ–™é€å‡ºæˆåŠŸ");
          scanned = [];
          updateDisplay();
        } else {
          log("âŒ è³‡æ–™é€å‡ºå¤±æ•—");
        }
      });
    });

    function updateDisplay() {
      document.getElementById("sn-display").innerHTML =
        scanned.map(sn => `<span class="tag">${sn}</span>`).join("");
    }

    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      document.getElementById("log").innerHTML += `[${ts}] ${msg}<br>`;
    }

    if (!window.dd) {
      log("âŒ JSAPI å°šæœªæ³¨å…¥ï¼Œè«‹å¾é‡˜é‡˜æ‡‰ç”¨åœ–ç¤ºé€²å…¥");
    } else {
      log("âœ… å·²åµæ¸¬åˆ° JSAPI å¯ä½¿ç”¨");
    }
  </script>
</body>
</html>
