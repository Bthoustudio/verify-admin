<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é˜²å½ç“¶è™ŸæŸ¥é©—ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://g.alicdn.com/dingding/open-develop/1.12.3/dingtalk.open.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4">æ°´å®…ç ”å±…ï½œé˜²å½ç“¶è™ŸæŸ¥é©—ç³»çµ±</h1>

    <div class="mb-4">
      <label for="mode" class="block font-medium mb-1">é¸æ“‡æ¨¡å¼</label>
      <select id="mode" class="w-full border rounded p-2">
        <option value="">è«‹é¸æ“‡</option>
        <option value="register">ğŸ“¦ å‡ºè²¨æ¨¡å¼</option>
        <option value="revoke">â™»ï¸ å›æ”¶æ¨¡å¼</option>
      </select>
    </div>

    <div class="mb-4" id="storeSelectContainer" style="display: none;">
      <label for="store" class="block font-medium mb-1">é¸æ“‡åˆ†åº—</label>
      <select id="store" class="w-full border rounded p-2"></select>
    </div>

    <div class="mb-4">
      <button id="scanButton" class="bg-blue-600 text-white px-4 py-2 rounded w-full">ğŸ“· æƒæ QR Code</button>
    </div>

    <div class="mb-4">
      <ul id="logList" class="text-sm space-y-1"></ul>
    </div>
  </div>

  <script>
    const modeSelect = document.getElementById("mode");
    const storeSelect = document.getElementById("store");
    const scanButton = document.getElementById("scanButton");
    const storeSelectContainer = document.getElementById("storeSelectContainer");
    const logList = document.getElementById("logList");

    modeSelect.addEventListener("change", () => {
      const mode = modeSelect.value;
      storeSelectContainer.style.display = mode === "register" ? "block" : "none";
      log(`æ¨¡å¼åˆ‡æ›ç‚ºï¼š${mode === "register" ? "å‡ºè²¨" : "å›æ”¶"}`);
    });

    scanButton.addEventListener("click", () => {
      if (typeof dd === "undefined") {
        log("âŒ ç„¡æ³•å•Ÿå‹•æƒç¢¼å™¨ï¼Œdd å°šæœªæ³¨å…¥");
        alert("è«‹å¾é‡˜é‡˜æ‡‰ç”¨é€²å…¥ç³»çµ±ï¼Œå¦å‰‡ç„¡æ³•å•Ÿç”¨æƒç¢¼åŠŸèƒ½ã€‚");
        return;
      }
      dd.ready(() => {
        dd.biz.util.scan({
          type: "qrCode",
          onSuccess: function (res) {
            log("âœ… æƒæçµæœï¼š" + res.text);
          },
          onFail: function (err) {
            log("âŒ æƒæå¤±æ•—ï¼š" + JSON.stringify(err));
          },
        });
      });
    });

    function log(message) {
      const li = document.createElement("li");
      li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logList.prepend(li);
    }

    // è‡ªå‹•è¼‰å…¥åº—å®¶
    fetch("https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec")
      .then((res) => res.json())
      .then((data) => {
        data.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.store;
          opt.textContent = item.store;
          storeSelect.appendChild(opt);
        });
      })
      .catch(() => {
        log("âŒ ç„¡æ³•è¼‰å…¥åº—å®¶æ¸…å–®");
      });

    // JSAPI åµéŒ¯æç¤º
    window.addEventListener("load", () => {
      setTimeout(() => {
        if (typeof dd === "undefined") {
          const warn = document.createElement("div");
          warn.style.position = "fixed";
          warn.style.top = "20px";
          warn.style.left = "50%";
          warn.style.transform = "translateX(-50%)";
          warn.style.backgroundColor = "#ff4d4f";
          warn.style.color = "white";
          warn.style.padding = "12px 20px";
          warn.style.borderRadius = "8px";
          warn.style.zIndex = "9999";
          warn.style.fontSize = "16px";
          warn.innerText = "âŒ JSAPI å°šæœªæ³¨å…¥ï¼Œè«‹å¾é‡˜é‡˜æ‡‰ç”¨åœ–ç¤ºé€²å…¥";
          document.body.appendChild(warn);
        } else {
          console.log("âœ… JSAPI å·²æ³¨å…¥ï¼Œdd ç‰©ä»¶å¯ç”¨");
        }
      }, 1000);
    });
  </script>
</body>
</html>
