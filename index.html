<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>倉管掃碼系統｜強化掃描修正版</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 20px; text-align: center; }
    h2 { color: #05668d; }
    select, button { font-size: 18px; padding: 10px; margin: 10px auto; display: block; width: 90%; max-width: 400px; border-radius: 8px; }
    button { background: #05668d; color: #fff; border: none; cursor: pointer; }
    #video-container { margin-top: 20px; }
    video { width: 100%; max-width: 400px; border: 2px solid #ccc; border-radius: 8px; }
    .tag { background: #ddd; padding: 6px 10px; margin: 5px; display: inline-block; border-radius: 5px; }
    #status { color: #c00; font-size: 16px; margin-top: 10px; white-space: pre-line; }
  </style>
</head>
<body>
  <h2>📦 倉庫掃碼系統（曲面強化修正版）</h2>

  <button onclick="setMode('register')">📦 出貨模式</button>
  <button onclick="setMode('revoke')">🔁 回收模式</button>

  <div id="shop-block" style="display:none">
    <select id="shop-dropdown">
      <option value="">請選擇出貨店家</option>
    </select>
  </div>

  <div id="shop-name"></div>
  <div id="video-container" style="display:none">
    <video id="preview" autoplay muted playsinline></video>
  </div>
  <div id="status"></div>
  <div id="sn-list"></div>

  <button onclick="submitData()" style="display:none" id="submit-btn">📤 送出資料</button>

  <script>
    const dropdown = document.getElementById("shop-dropdown");
    const shopNameDiv = document.getElementById("shop-name");
    const snListDiv = document.getElementById("sn-list");
    const video = document.getElementById("preview");
    const status = document.getElementById("status");
    const shopBlock = document.getElementById("shop-block");
    const videoContainer = document.getElementById("video-container");
    const submitBtn = document.getElementById("submit-btn");

    const sheetURL = "https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec";
    const webhookURL = "https://hook.us2.make.com/s6ibl5e715634fhq7ess7sc5bv0fuj6h";

    let shopName = "";
    let mode = "";
    let scanned = [];
    const codeReader = new ZXing.BrowserMultiFormatReader();

    function setMode(m) {
      mode = m;
      scanned = [];
      document.querySelector("button[onclick*=register]").style.display = "none";
      document.querySelector("button[onclick*=revoke]").style.display = "none";
      if (mode === 'register') {
        shopBlock.style.display = "block";
      } else {
        shopName = "";
        startScan();
      }
    }

    dropdown.addEventListener("change", () => {
      if (dropdown.value) {
        shopName = dropdown.value;
        shopNameDiv.innerText = `✅ 出貨店家：${shopName}`;
        startScan();
      }
    });

    async function startScan() {
      shopBlock.style.display = "none";
      videoContainer.style.display = "block";
      submitBtn.style.display = "block";
      status.innerText = "🔄 啟動鏡頭中，請確認允許相機權限...";

      try {
        await codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            const text = result.getText();
            let sn = text.includes("?") ? new URLSearchParams(text.split("?")[1]).get("sn") : text;
            if (sn && !scanned.includes(sn)) {
              scanned.push(sn);
              updateList();
              status.innerText = `✅ 掃到瓶號：${sn}`;
            } else {
              status.innerText = `⚠️ 重複或無效 QR`;
            }
          }
        });
      } catch (e) {
        console.error("鏡頭錯誤：", e);
        status.innerText = `❌ 鏡頭啟用失敗：\n${e.message || e}`;
      }
    }

    function updateList() {
      snListDiv.innerHTML = scanned.map(sn => `<span class='tag'>${sn}</span>`).join('');
    }

    function submitData() {
      if (mode === "register" && !shopName) {
        status.innerText = "⚠️ 請先選擇店家";
        return;
      }
      if (scanned.length === 0) {
        status.innerText = "⚠️ 請至少掃描一組瓶號";
        return;
      }
      const payload = {
        mode,
        shop: shopName,
        sn_list: scanned,
        operator: "倉管"
      };
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(r => {
        if (r.ok) {
          status.innerText = "✅ 資料已成功送出！";
        } else {
          status.innerText = "❌ 傳送失敗";
        }
      }).catch(err => {
        status.innerText = `❌ 錯誤：${err.message}`;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetch(sheetURL).then(r => r.json()).then(data => {
        data.forEach(row => {
          if (row.分店) {
            let op = document.createElement("option");
            op.value = op.text = row.分店;
            dropdown.appendChild(op);
          }
        });
      }).catch(err => {
        status.innerText = `❌ 店家清單載入錯誤：${err.message}`;
      });
    });
  </script>
</body>
</html>
