
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>水宅倉庫掃碼系統（釘釘專用）</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.3/dingtalk.open.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-xl font-bold mb-4">📦 水宅倉庫掃碼系統</h1>

    <div class="mb-4">
      <label class="block font-medium mb-1">選擇模式</label>
      <select id="mode" class="w-full border rounded p-2">
        <option value="">請選擇</option>
        <option value="register">📤 出貨模式</option>
        <option value="revoke">♻️ 回收模式</option>
      </select>
    </div>

    <div id="storeWrap" class="mb-4 hidden">
      <label class="block font-medium mb-1">選擇分店</label>
      <select id="store" class="w-full border rounded p-2"></select>
    </div>

    <div class="mb-4">
      <button id="scanBtn" class="bg-blue-600 text-white px-4 py-2 w-full rounded">📷 掃描 QR Code</button>
    </div>

    <div class="mb-4">
      <button id="submitBtn" class="bg-green-600 text-white px-4 py-2 w-full rounded hidden">📤 送出資料</button>
    </div>

    <ul id="logList" class="text-sm space-y-1"></ul>
  </div>

  <script>
    const modeEl = document.getElementById("mode");
    const storeWrap = document.getElementById("storeWrap");
    const storeEl = document.getElementById("store");
    const scanBtn = document.getElementById("scanBtn");
    const submitBtn = document.getElementById("submitBtn");
    const logList = document.getElementById("logList");

    let mode = "";
    let store = "";
    let scanned = [];

    modeEl.addEventListener("change", () => {
      mode = modeEl.value;
      storeWrap.style.display = (mode === "register") ? "block" : "none";
      log("切換模式：" + (mode === "register" ? "📤 出貨模式" : "♻️ 回收模式"));
    });

    storeEl.addEventListener("change", () => {
      store = storeEl.value;
      log("已選擇分店：" + store);
    });

    scanBtn.addEventListener("click", () => {
      store = storeEl.value;
      if (mode === "register" && !store) {
        alert("請先選擇分店");
        return;
      }

      if (typeof window.dd === "undefined") {
        alert("❌ JSAPI 尚未注入，請從釘釘應用圖示重新開啟。");
        return;
      }

      dd.ready(() => {
        dd.biz.util.scan({
          type: "qrCode",
          onSuccess: function (res) {
            const sn = new URLSearchParams(res.text.split("?")[1]).get("sn");
            if (sn && !scanned.includes(sn)) {
              scanned.push(sn);
              log("✅ 掃描成功：" + sn);
              submitBtn.classList.remove("hidden");
            } else {
              log("⚠️ 無效或重複瓶號");
            }
          },
          onFail: function (err) {
            log("❌ 掃描失敗：" + JSON.stringify(err));
          }
        });
      });
    });

    submitBtn.addEventListener("click", () => {
      if (scanned.length === 0) {
        log("⚠️ 尚未掃描任何瓶號");
        return;
      }
      fetch("https://hook.us2.make.com/s6ibl5e715634fhq7ess7sc5bv0fuj6h", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode, shop: store, sn_list: scanned, operator: "倉管" })
      }).then(res => {
        if (res.ok) {
          log("✅ 資料已送出");
          scanned = [];
          submitBtn.classList.add("hidden");
        } else {
          log("❌ 資料送出失敗");
        }
      });
    });

    function log(msg) {
      const li = document.createElement("li");
      li.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logList.prepend(li);
    }

    fetch("https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec")
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.store || item.分店;
          opt.textContent = item.store || item.分店;
          storeEl.appendChild(opt);
        });

        log("✅ 成功載入分店清單");
        if (storeEl.options.length > 0) {
          storeEl.selectedIndex = 0;
          storeEl.dispatchEvent(new Event("change"));
        }
      })
      .catch(() => log("❌ 載入分店清單失敗"));

    // ✅ 加入 retry 偵測機制
    function waitForJSAPI(retry = 10) {
      if (typeof window.dd !== "undefined") {
        log("✅ 偵測到 JSAPI 已注入");
        return;
      }
      if (retry > 0) {
        setTimeout(() => waitForJSAPI(retry - 1), 400);
      } else {
        alert("❌ 無法偵測到 JSAPI，請關閉後從釘釘應用圖示重新開啟");
      }
    }
    window.onload = () => waitForJSAPI();
  </script>
</body>
</html>
