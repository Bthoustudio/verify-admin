<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€‰ç®¡æƒç¢¼ç³»çµ±ï½œå¼·åŒ–æƒæä¿®æ­£ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 20px; text-align: center; }
    h2 { color: #05668d; }
    select, button { font-size: 18px; padding: 10px; margin: 10px auto; display: block; width: 90%; max-width: 400px; border-radius: 8px; }
    button { background: #05668d; color: #fff; border: none; cursor: pointer; }
    #video-container { margin-top: 20px; }
    video { width: 100%; max-width: 400px; border: 2px solid #ccc; border-radius: 8px; }
    .tag { background: #ddd; padding: 6px 10px; margin: 5px; display: inline-block; border-radius: 5px; }
    #status { color: #c00; font-size: 16px; margin-top: 10px; white-space: pre-line; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ å€‰åº«æƒç¢¼ç³»çµ±ï¼ˆæ›²é¢å¼·åŒ–ä¿®æ­£ç‰ˆï¼‰</h2>

  <button onclick="setMode('register')">ğŸ“¦ å‡ºè²¨æ¨¡å¼</button>
  <button onclick="setMode('revoke')">ğŸ” å›æ”¶æ¨¡å¼</button>

  <div id="shop-block" style="display:none">
    <select id="shop-dropdown">
      <option value="">è«‹é¸æ“‡å‡ºè²¨åº—å®¶</option>
    </select>
  </div>

  <div id="shop-name"></div>
  <div id="video-container" style="display:none">
    <video id="preview" autoplay muted playsinline></video>
  </div>
  <div id="status"></div>
  <div id="sn-list"></div>

  <button onclick="submitData()" style="display:none" id="submit-btn">ğŸ“¤ é€å‡ºè³‡æ–™</button>

  <script>
    const dropdown = document.getElementById("shop-dropdown");
    const shopNameDiv = document.getElementById("shop-name");
    const snListDiv = document.getElementById("sn-list");
    const video = document.getElementById("preview");
    const status = document.getElementById("status");
    const shopBlock = document.getElementById("shop-block");
    const videoContainer = document.getElementById("video-container");
    const submitBtn = document.getElementById("submit-btn");

    const sheetURL = "https://script.google.com/macros/s/AKfycbzdbRSV-DBTf5z_FJkVDNRrqxNnUy2tddIulq-NTGBtlEj3Vu_A7Yf0gvv6mNCJyJpeQQ/exec";
    const webhookURL = "https://hook.us2.make.com/s6ibl5e715634fhq7ess7sc5bv0fuj6h";

    let shopName = "";
    let mode = "";
    let scanned = [];
    const codeReader = new ZXing.BrowserMultiFormatReader();

    function setMode(m) {
      mode = m;
      scanned = [];
      document.querySelector("button[onclick*=register]").style.display = "none";
      document.querySelector("button[onclick*=revoke]").style.display = "none";
      if (mode === 'register') {
        shopBlock.style.display = "block";
      } else {
        shopName = "";
        startScan();
      }
    }

    dropdown.addEventListener("change", () => {
      if (dropdown.value) {
        shopName = dropdown.value;
        shopNameDiv.innerText = `âœ… å‡ºè²¨åº—å®¶ï¼š${shopName}`;
        startScan();
      }
    });

    async function startScan() {
      shopBlock.style.display = "none";
      videoContainer.style.display = "block";
      submitBtn.style.display = "block";
      status.innerText = "ğŸ”„ å•Ÿå‹•é¡é ­ä¸­ï¼Œè«‹ç¢ºèªå…è¨±ç›¸æ©Ÿæ¬Šé™...";

      try {
        await codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            const text = result.getText();
            let sn = text.includes("?") ? new URLSearchParams(text.split("?")[1]).get("sn") : text;
            if (sn && !scanned.includes(sn)) {
              scanned.push(sn);
              updateList();
              status.innerText = `âœ… æƒåˆ°ç“¶è™Ÿï¼š${sn}`;
            } else {
              status.innerText = `âš ï¸ é‡è¤‡æˆ–ç„¡æ•ˆ QR`;
            }
          }
        });
      } catch (e) {
        console.error("é¡é ­éŒ¯èª¤ï¼š", e);
        status.innerText = `âŒ é¡é ­å•Ÿç”¨å¤±æ•—ï¼š\n${e.message || e}`;
      }
    }

    function updateList() {
      snListDiv.innerHTML = scanned.map(sn => `<span class='tag'>${sn}</span>`).join('');
    }

    function submitData() {
      if (mode === "register" && !shopName) {
        status.innerText = "âš ï¸ è«‹å…ˆé¸æ“‡åº—å®¶";
        return;
      }
      if (scanned.length === 0) {
        status.innerText = "âš ï¸ è«‹è‡³å°‘æƒæä¸€çµ„ç“¶è™Ÿ";
        return;
      }
      const payload = {
        mode,
        shop: shopName,
        sn_list: scanned,
        operator: "å€‰ç®¡"
      };
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(r => {
        if (r.ok) {
          status.innerText = "âœ… è³‡æ–™å·²æˆåŠŸé€å‡ºï¼";
        } else {
          status.innerText = "âŒ å‚³é€å¤±æ•—";
        }
      }).catch(err => {
        status.innerText = `âŒ éŒ¯èª¤ï¼š${err.message}`;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetch(sheetURL).then(r => r.json()).then(data => {
        data.forEach(row => {
          if (row.åˆ†åº—) {
            let op = document.createElement("option");
            op.value = op.text = row.åˆ†åº—;
            dropdown.appendChild(op);
          }
        });
      }).catch(err => {
        status.innerText = `âŒ åº—å®¶æ¸…å–®è¼‰å…¥éŒ¯èª¤ï¼š${err.message}`;
      });
    });
  </script>
</body>
</html>
